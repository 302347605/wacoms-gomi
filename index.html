<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>WACOMS ã”ã¿åé›†è¨˜éŒ²</title>
<style>
:root{--primary:#2E7D32;--primary-light:#4CAF50;--danger:#C62828;--bg:#E8E8E0;--text:#212121;--text-sec:#616161;--border:#BDBDBD;--header-bg:#37474F;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:-apple-system,'Hiragino Sans','Hiragino Kaku Gothic ProN',sans-serif;background:var(--bg);color:var(--text);font-size:14px;overflow-x:hidden;min-height:100vh;min-height:100dvh;}
.header{background:var(--header-bg);color:#fff;padding:4px 12px;display:flex;align-items:center;justify-content:space-between;height:36px;position:sticky;top:0;z-index:100;}
.header-title{font-size:14px;font-weight:700;letter-spacing:0.5px;white-space:nowrap;}
.header-right{display:flex;align-items:center;gap:12px;}
.status-item{display:flex;align-items:center;gap:3px;font-size:10px;}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--primary-light);}
.mic-ind{display:flex;align-items:center;gap:3px;font-size:10px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,0.15);}
.mic-ind .d{width:8px;height:8px;border-radius:50%;}.mic-ind .d.on{background:#4CAF50;}.mic-ind .d.off{background:#C62828;}
.voice-bar{display:flex;align-items:center;gap:8px;margin-left:12px;}
.voice-btn{width:28px;height:28px;border-radius:50%;border:none;background:var(--primary-light);color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;}
.voice-btn.listening{background:var(--danger);animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(198,40,40,0.4);}50%{box-shadow:0 0 0 8px rgba(198,40,40,0);}}
.voice-info{font-size:10px;line-height:1.3;max-width:180px;}.voice-step{opacity:0.7;}.voice-text{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.app-body{display:flex;flex-direction:column;height:calc(100vh - 36px);height:calc(100dvh - 36px);}
.input-area{display:flex;align-items:stretch;padding:6px;gap:6px;flex-shrink:0;}
.photo-box{width:90px;min-height:80px;background:#D0D0C8;border:2px solid var(--border);border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.photo-box img{width:100%;height:100%;object-fit:cover;}.photo-box .no-photo{font-size:10px;color:#999;text-align:center;}.photo-box .no-photo span{font-size:24px;display:block;}
.input-col{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;min-width:0;}
.input-col .arr{width:100%;max-width:120px;height:28px;border:1px solid var(--border);border-radius:5px;background:#F0F0E8;font-size:16px;color:#1565C0;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.input-col .arr:active{background:#D0D0C8;}
.iv{width:100%;max-width:120px;height:40px;border:2px solid var(--border);border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 4px;}
.iv.qty{font-size:28px;max-width:100px;}.il{font-size:10px;color:var(--text-sec);text-align:center;white-space:nowrap;}
.qty-col{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;flex:0.8;}
.rec-col{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;flex-shrink:0;padding-bottom:2px;}
.rec-btn{padding:8px 16px;border:2px solid var(--primary);border-radius:6px;background:#fff;color:var(--primary);font-size:16px;font-weight:900;cursor:pointer;white-space:nowrap;}
.rec-btn:active{background:var(--primary);color:#fff;}
.rec-area{flex:1;display:flex;flex-direction:column;min-height:0;border-top:2px solid var(--border);background:#F5F5F0;}
.rec-hdr{display:flex;justify-content:space-between;align-items:center;padding:4px 10px;font-size:12px;font-weight:700;background:#E0E0D8;flex-shrink:0;}
.rec-hdr-btns{display:flex;gap:6px;}.rec-hdr-btns button{font-size:10px;padding:3px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;cursor:pointer;}.rec-hdr-btns .del{color:var(--danger);border-color:var(--danger);}
.rec-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.no-rec{text-align:center;color:#999;padding:20px;font-size:13px;}
.ri{display:flex;align-items:center;gap:6px;padding:6px 10px;border-bottom:1px solid var(--border);font-size:12px;}
.rt{font-size:10px;color:var(--text-sec);min-width:40px;}.rp{flex:1;font-weight:600;}.ry{color:var(--text-sec);min-width:60px;}.rq{font-weight:700;min-width:30px;text-align:right;}
.toolbar{display:flex;border-top:2px solid var(--border);background:#E0E0D8;flex-shrink:0;}
.tb{flex:1;padding:8px;border:none;background:transparent;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;}.tb:active{background:#D0D0C8;}.tb+.tb{border-left:1px solid var(--border);}
.np-ovl{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}.np-ovl.show{opacity:1;pointer-events:auto;}
.np-pan{background:#fff;border-radius:12px;padding:12px;width:260px;box-shadow:0 8px 32px rgba(0,0,0,0.2);}
.np-disp{background:#F5F5F0;border:2px solid var(--border);border-radius:8px;padding:10px;font-size:32px;font-weight:700;text-align:right;margin-bottom:8px;min-height:48px;}
.np-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.nk{height:44px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:20px;font-weight:700;cursor:pointer;}.nk:active{background:#E0E0E0;}.nk.fn{font-size:12px;background:#F0F0E8;}.nk.enter{grid-row:span 2;background:var(--primary);color:#fff;border-color:var(--primary);font-size:14px;font-weight:800;}
.set-ovl{position:fixed;inset:0;background:#fff;z-index:300;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.3s;}.set-ovl.show{transform:none;}
.set-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--header-bg);color:#fff;}.set-hdr h2{font-size:16px;}.set-x{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:4px 8px;}
.set-body{flex:1;overflow-y:auto;padding:12px;}.set-tabs{display:flex;gap:8px;margin-bottom:12px;}.set-tab{flex:1;padding:8px;border:2px solid var(--border);border-radius:8px;background:#fff;font-size:13px;font-weight:700;cursor:pointer;}.set-tab.active{border-color:var(--primary);background:#E8F5E9;color:var(--primary);}
.ml{display:flex;flex-direction:column;gap:6px;}.mi{display:flex;align-items:center;gap:8px;padding:8px;background:#F5F5F0;border-radius:8px;border:1px solid var(--border);}
.mi-ph{width:48px;height:48px;border-radius:6px;background:#D0D0C8;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;}.mi-ph img{width:100%;height:100%;object-fit:cover;}
.mi-i{flex:1;min-width:0;}.mi-n{font-weight:700;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.mi-s{font-size:11px;color:var(--text-sec);}
.mi-a{display:flex;gap:4px;}.mi-a button{padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:14px;}.mi-a .del{color:var(--danger);border-color:var(--danger);}
.add-btn{width:100%;padding:10px;border:2px dashed var(--border);border-radius:8px;background:transparent;font-size:16px;color:var(--primary);cursor:pointer;margin-top:12px;font-weight:700;}
.frm-ovl{position:fixed;inset:0;background:#fff;z-index:400;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.3s;}.frm-ovl.show{transform:none;}
.frm-body{flex:1;overflow-y:auto;padding:16px;}.fg{margin-bottom:16px;}.fg label{display:block;font-size:12px;font-weight:700;color:var(--text-sec);margin-bottom:4px;}.fg input{width:100%;padding:10px;border:2px solid var(--border);border-radius:6px;font-size:16px;}
.pp{width:100%;height:100px;border:2px dashed var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#F5F5F0;cursor:pointer;overflow:hidden;font-size:12px;color:#999;}.pp span{font-size:28px;}.pp img{width:100%;height:100%;object-fit:cover;}
.ph-btns{display:flex;gap:8px;margin-top:8px;}.ph-btn{flex:1;padding:10px;border:2px solid var(--primary);border-radius:8px;background:#E8F5E9;cursor:pointer;font-size:13px;font-weight:700;color:var(--primary);text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px;}.ph-btn span{font-size:20px;}.ph-btn:active{background:var(--primary);color:#fff;}
.frm-sv{width:100%;padding:12px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-size:16px;font-weight:800;cursor:pointer;margin-top:8px;}
.exp-ovl{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}.exp-ovl.show{opacity:1;pointer-events:auto;}.exp-box{background:#fff;border-radius:12px;padding:16px;width:90%;max-width:400px;max-height:80vh;display:flex;flex-direction:column;}.exp-box h3{margin-bottom:8px;}.exp-box textarea{flex:1;min-height:200px;border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:11px;resize:none;}.exp-btns{display:flex;gap:8px;margin-top:8px;}.exp-btns button{flex:1;padding:10px;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;}.cl{background:#E0E0E0;}.cp{background:var(--primary);color:#fff;}
.toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%) translateY(20px);background:#333;color:#fff;padding:8px 20px;border-radius:20px;font-size:13px;font-weight:600;opacity:0;pointer-events:none;transition:all 0.3s;z-index:9999;}.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
@media (orientation:portrait){
.input-area{flex-wrap:wrap;justify-content:center;}.photo-box{width:100%;height:80px;}.input-col,.qty-col{flex:1 1 30%;min-width:80px;}.iv{max-width:100%;}.iv.qty{max-width:100%;}.input-col .arr{max-width:100%;}.rec-col{width:100%;padding:4px 0;}.rec-btn{width:100%;padding:12px;font-size:18px;background:var(--primary);color:#fff;border-radius:8px;}.np-ovl{align-items:flex-end;justify-content:center;}.np-pan{width:100%;max-width:340px;border-radius:12px 12px 0 0;}}
</style>
</head>
<body>
<div class="header">
<div class="header-title">WACOMS ã”ã¿åé›†è¨˜éŒ² <span style="font-size:9px;opacity:0.5">v1.7.0</span></div>
<div class="voice-bar"><button class="voice-btn" id="vBtn" onclick="toggleVoice()">ğŸ¤</button><div class="voice-info"><div class="voice-step" id="vStep">ğŸ¤ ã‚¿ãƒƒãƒ—ã§ON</div><div class="voice-text" id="vText">ãƒã‚¤ã‚¯OFF</div></div></div>
<div class="header-right"><div class="mic-ind"><div class="d off" id="micD"></div><span id="micL">OFF</span></div><div class="status-item"><div class="status-dot"></div><span>æ¥ç¶šä¸­</span></div></div>
</div>
<div class="app-body">
<div class="input-area">
<div class="photo-box" id="pBox"><div class="no-photo"><span>ğŸ“·</span>å†™çœŸãªã—</div></div>
<div class="input-col"><button class="arr" onclick="cyP(-1)">â–²</button><div class="iv" id="pVal">---</div><button class="arr" onclick="cyP(1)">â–¼</button><div class="il">åé›†å ´æ‰€</div></div>
<div class="input-col"><button class="arr" onclick="cyT(-1)">â–²</button><div class="iv" id="tVal">---</div><button class="arr" onclick="cyT(1)">â–¼</button><div class="il">ã”ã¿ç¨®åˆ¥</div></div>
<div class="qty-col"><div class="iv qty" id="qVal" onclick="openNP()">0</div><div class="il">åé›†é‡</div></div>
<div class="rec-col"><button class="rec-btn" onclick="saveRec()">è¨˜éŒ²</button></div>
</div>
<div class="rec-area"><div class="rec-hdr"><span>ğŸ“‹ è¨˜éŒ²ä¸€è¦§</span><div class="rec-hdr-btns"><button onclick="showExp()">CSV</button><button class="del" onclick="clearRecs()">å…¨å‰Šé™¤</button></div></div><div class="rec-scroll" id="recScr"><div class="no-rec">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div></div>
<div class="toolbar"><button class="tb" onclick="openSet()"><span>âš™ï¸</span>è¨­å®š</button><button class="tb" onclick="showExp()"><span>ğŸ“¤</span>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button></div>
</div>
<div class="np-ovl" id="npOvl" onclick="if(event.target===this){qty=numV||'0';this.classList.remove('show');upd();}"><div class="np-pan" onclick="event.stopPropagation()"><div class="np-disp" id="npD">0</div><div class="np-grid"><button class="nk" onclick="nk('7')">7</button><button class="nk" onclick="nk('8')">8</button><button class="nk" onclick="nk('9')">9</button><button class="nk fn" onclick="nk('C')">Clear</button><button class="nk" onclick="nk('4')">4</button><button class="nk" onclick="nk('5')">5</button><button class="nk" onclick="nk('6')">6</button><button class="nk fn" onclick="nk('B')">âŒ«</button><button class="nk" onclick="nk('1')">1</button><button class="nk" onclick="nk('2')">2</button><button class="nk" onclick="nk('3')">3</button><button class="nk enter" onclick="nk('E')">Enter</button><button class="nk" onclick="nk('0')">0</button><button class="nk" onclick="nk('.')">.</button><button class="nk" onclick="nk('-')">-</button></div></div></div>
<div class="set-ovl" id="setOvl"><div class="set-hdr"><h2>âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼è¨­å®š</h2><button class="set-x" onclick="closeSet()">âœ•</button></div><div class="set-body"><div class="set-tabs"><button class="set-tab active" id="tabP" onclick="swT('place')">ğŸ“ åé›†å ´æ‰€</button><button class="set-tab" id="tabT" onclick="swT('type')">ğŸ—‘ï¸ ã”ã¿ç¨®åˆ¥</button></div><div id="mCtn"></div><button class="add-btn" onclick="addM()">ï¼‹ æ–°è¦è¿½åŠ </button></div></div>
<div class="frm-ovl" id="frmOvl"><div class="set-hdr"><h2 id="frmTtl">è¿½åŠ </h2><button class="set-x" onclick="closeFrm()">âœ•</button></div><div class="frm-body"><div class="fg" id="fgPh"><label>å†™çœŸ</label><div class="pp" id="pp"><span>ğŸ“·</span>ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠ</div><div class="ph-btns"><button class="ph-btn" onclick="document.getElementById('phCam').click()"><span>ğŸ“¸</span>æ’®å½±</button><button class="ph-btn" onclick="document.getElementById('phLib').click()"><span>ğŸ–¼ï¸</span>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</button></div><input type="file" id="phCam" accept="image/*" capture="environment" style="display:none" onchange="onPh(event)"><input type="file" id="phLib" accept="image/*" style="display:none" onchange="onPh(event)"></div><div class="fg"><label>åå‰</label><input type="text" id="fN" placeholder="åå‰ã‚’å…¥åŠ›"></div><div class="fg" id="fgGps"><label>GPSåº§æ¨™ <button style="font-size:10px;background:var(--primary);color:#fff;border:none;border-radius:3px;padding:2px 6px;cursor:pointer" onclick="getGPS()">ç¾åœ¨åœ°å–å¾—</button></label><input type="text" id="fLa" placeholder="ç·¯åº¦"><input type="text" id="fLo" placeholder="çµŒåº¦" style="margin-top:4px"></div><button class="frm-sv" onclick="saveFrm()">ä¿å­˜</button></div></div>
<div class="exp-ovl" id="eOvl" onclick="if(event.target===this)this.classList.remove('show')"><div class="exp-box" onclick="event.stopPropagation()"><h3>ğŸ“‹ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3><textarea id="eTxt" readonly></textarea><div class="exp-btns"><button class="cl" onclick="document.getElementById('eOvl').classList.remove('show')">é–‰ã˜ã‚‹</button><button class="cp" onclick="cpExp()">ã‚³ãƒ”ãƒ¼</button></div></div></div>
<div class="toast" id="toast"></div>
<script>
var P=[],T=[],R=[],pI=0,tI=0,qty='0',numV='';
var cTab='place',eI=-1,ePh=null;
var vOn=false,vS=0,srObj=null,gLa=null,gLo=null;
var micOK=false,ttsOK=false;
var srRunning=false,ttsActive=false;
var vGotP=false,vGotT=false,vGotQ=false;
var srRestarts=0; // consecutive restarts without result (limit=3)
var isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);
var hasSR=!!(window.SpeechRecognition||window.webkitSpeechRecognition);

// === APP INIT: immediate, no start screen ===
window.onload=function(){
  ld();
  if(!P.length){P=[{name:'ãƒ¦ãƒ‹ã‚¯ãƒ­',lat:35.6812,lng:139.7671,photo:null},{name:'ã‚³ãƒ³ãƒ“ãƒ‹å‰',lat:35.6815,lng:139.7675,photo:null},{name:'å…¬åœ’å…¥å£',lat:35.6808,lng:139.7668,photo:null},{name:'é§…å‰',lat:35.682,lng:139.768,photo:null}];sP();}
  if(!T.length){T=[{name:'ç‡ƒãˆã‚‹ã”ã¿'},{name:'ãƒªã‚µã‚¤ã‚¯ãƒ«'},{name:'ä¸ç‡ƒã”ã¿'},{name:'ãƒšãƒƒãƒˆãƒœãƒˆãƒ«'},{name:'ç¼¶ãƒ»ãƒ“ãƒ³'}];sT();}
  upd();rRec();initGPS();
  if(!hasSR){document.getElementById('vStep').textContent='éŸ³å£°éå¯¾å¿œ';}
};

// === TTS ===
function unlockTTS(){
  if(ttsOK)return;
  if(!window.speechSynthesis)return;
  ttsOK=true;
  try{var u=new SpeechSynthesisUtterance('');u.volume=0;u.lang='ja-JP';speechSynthesis.speak(u);speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=function(){speechSynthesis.getVoices();};}catch(e){}
  try{var ac=new(window.AudioContext||window.webkitAudioContext)();var b=ac.createBuffer(1,1,22050),s=ac.createBufferSource();s.buffer=b;s.connect(ac.destination);s.start(0);if(ac.state==='suspended')ac.resume();}catch(e){}
}
function speak(text,cb){
  if(!ttsOK||!speechSynthesis){if(cb)setTimeout(cb,100);return;}
  speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);u.lang='ja-JP';u.rate=1.1;u.volume=1.0;
  var vs=speechSynthesis.getVoices();var ja=vs.find(function(v){return v.lang&&v.lang.startsWith('ja');});if(ja)u.voice=ja;
  var done=false;var fin=function(){if(!done){done=true;if(cb)cb();}};
  u.onend=fin;u.onerror=fin;speechSynthesis.speak(u);
  if(isIOS){var iv=setInterval(function(){if(!speechSynthesis.speaking){clearInterval(iv);fin();return;}speechSynthesis.pause();speechSynthesis.resume();},4000);u.onend=function(){clearInterval(iv);fin();};u.onerror=function(){clearInterval(iv);fin();};}
  setTimeout(fin,Math.max(3000,text.length*200));
}
function speakTTS(text){
  ttsActive=true;
  speak(text,function(){ttsActive=false;});
}

// === SPEECH RECOGNITION ===
// start() on first mic tap. Auto-restart in onend with delay + counter limit.
// Counter prevents infinite banner loop. Reset on successful result.

function createSR(){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  srObj=new SR();
  srObj.lang='ja-JP';
  srObj.interimResults=true;
  srObj.continuous=true;
  srObj.onresult=function(e){
    if(ttsActive||!vOn)return;
    var fin='',interim='';
    for(var i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal)fin+=e.results[i][0].transcript;
      else interim+=e.results[i][0].transcript;
    }
    document.getElementById('vText').textContent=fin||interim||'...';
    if(fin){
      srRestarts=0; // got a result â†’ reset counter
      procV(fin);
    }
  };
  srObj.onend=function(){
    srRunning=false;
    updMic();
    // Auto-restart if in voice flow, within restart limit
    if(vOn&&srRestarts<3){
      srRestarts++;
      document.getElementById('vText').textContent='å†æ¥ç¶šä¸­...';
      setTimeout(function(){
        if(vOn&&!srRunning){
          try{srObj.start();srRunning=true;updMic();
            document.getElementById('vText').textContent='èã„ã¦ã„ã¾ã™...';
          }catch(e){
            vOn=false;vS=0;
            document.getElementById('vBtn').classList.remove('listening');
            document.getElementById('vStep').textContent='ğŸ¤ ã‚¿ãƒƒãƒ—ã§å†é–‹';
            document.getElementById('vText').textContent='å†æ¥ç¶šå¤±æ•—';
          }
        }
      },1500);
    }else if(vOn){
      // Too many restarts â†’ stop and ask user to tap
      vOn=false;vS=0;
      document.getElementById('vBtn').classList.remove('listening');
      document.getElementById('vStep').textContent='ğŸ¤ ã‚¿ãƒƒãƒ—ã§å†é–‹';
      document.getElementById('vText').textContent='éŸ³å£°ãŒåˆ‡ã‚Œã¾ã—ãŸ';
    }
  };
  srObj.onerror=function(e){
    if(e.error==='no-speech'){/* normal, onend will handle restart */}
    else if(e.error==='not-allowed'){
      srRunning=false;micOK=false;vOn=false;vS=0;
      document.getElementById('vBtn').classList.remove('listening');
      document.getElementById('vStep').textContent='ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™';
      document.getElementById('vText').textContent='è¨­å®šâ†’Safariâ†’ãƒã‚¤ã‚¯â†’è¨±å¯â†’ãƒªãƒ­ãƒ¼ãƒ‰';
      toast('ãƒã‚¤ã‚¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');updMic();
    }
    else if(e.error==='aborted'){srRunning=false;}
  };
}

// Start SR - only called from user tap gesture
function startSR(){
  if(!srObj)createSR();
  if(srRunning)return true;
  try{
    srObj.start();
    srRunning=true;micOK=true;
    updMic();
    return true;
  }catch(e){
    if(e.message&&e.message.indexOf('already started')>=0){srRunning=true;return true;}
    toast('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—');
    return false;
  }
}

function updMic(){
  var d=document.getElementById('micD'),l=document.getElementById('micL');
  if(micOK&&srRunning){d.className='d on';l.textContent='ON';}
  else{d.className='d off';l.textContent='OFF';}
}

// === VOICE FLOW ===
// Mic ON â†’ always listening. User speaks at any time.
// Parse place/type/quantity. Auto-record when all 3 found. Reset & keep listening.

function toggleVoice(){
  if(!hasSR){toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');return;}

  if(vOn){
    // Turn OFF mic
    vOn=false;vS=0;vGotP=false;vGotT=false;vGotQ=false;ttsActive=false;
    if(speechSynthesis)speechSynthesis.cancel();
    document.getElementById('vBtn').classList.remove('listening');
    document.getElementById('vStep').textContent='ğŸ¤ ã‚¿ãƒƒãƒ—ã§ON';
    document.getElementById('vText').textContent='ãƒã‚¤ã‚¯OFF';
    return;
  }

  // Unlock TTS on first user gesture
  unlockTTS();

  // Start SR if not running
  if(!srRunning){
    if(!startSR())return;
  }

  // Mic ON - always listening
  vOn=true;vS=0;vGotP=false;vGotT=false;vGotQ=false;srRestarts=0;
  document.getElementById('vBtn').classList.add('listening');
  document.getElementById('vStep').textContent='éŸ³å£°å¾…æ©Ÿä¸­';
  document.getElementById('vText').textContent='ã„ã¤ã§ã‚‚è©±ã—ã¦ãã ã•ã„';
  speakTTS('ãƒã‚¤ã‚¯ã‚’ONã—ã¾ã™');
}

// Reset after record â†’ back to idle listening
function resetVoice(){
  vS=0;vGotP=false;vGotT=false;vGotQ=false;
  if(vOn){
    document.getElementById('vStep').textContent='éŸ³å£°å¾…æ©Ÿä¸­';
    document.getElementById('vText').textContent='ã„ã¤ã§ã‚‚è©±ã—ã¦ãã ã•ã„';
  }
}

// All 3 found â†’ auto-record
function checkComplete(){
  if(vGotP&&vGotT&&vGotQ){
    var s=P[pI].name+'ã€'+T[tI].name+'ã€'+qty;
    document.getElementById('vStep').textContent='âœ“ ç™»éŒ²ä¸­...';
    document.getElementById('vText').textContent=s;
    // Auto-record
    var now=new Date();
    R.unshift({time:now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),date:now.toLocaleDateString('ja-JP'),place:P[pI].name,type:T[tI].name,qty:qty,ts:now.getTime()});
    sR();rRec();
    toast('âœ“ '+s+' è¨˜éŒ²ã—ã¾ã—ãŸ');
    speakTTS(s+'ã€‚è¨˜éŒ²ã—ã¾ã—ãŸ');
    // Reset for next input after short delay
    qty='0';upd();
    setTimeout(resetVoice,2000);
    return true;
  }
  return false;
}

function procV(txt){
  txt=txt.trim();

  if(vS===0){
    // === IDLE LISTENING: try to parse all 3 from utterance ===
    var parts=txt.split(/[ã€,\sã€€]+/);
    var foundP=-1,foundT=-1,foundQ=null,usedIdx={};
    for(var i=0;i<parts.length;i++){var m=bm(parts[i],P.map(function(p){return p.name;}));if(m>=0){foundP=m;usedIdx[i]=true;break;}}
    for(var j=0;j<parts.length;j++){if(usedIdx[j])continue;var m2=bm(parts[j],T.map(function(t){return t.name;}));if(m2>=0){foundT=m2;usedIdx[j]=true;break;}}
    for(var k=0;k<parts.length;k++){if(usedIdx[k])continue;var n=pNum(parts[k]);if(n!==null){foundQ=n;usedIdx[k]=true;break;}}
    // Fallback: full text matching
    if(foundP<0){for(var pi=0;pi<P.length;pi++){if(txt.indexOf(P[pi].name)>=0){foundP=pi;break;}}}
    if(foundT<0){for(var ti=0;ti<T.length;ti++){if(txt.indexOf(T[ti].name)>=0){foundT=ti;break;}}}
    if(foundQ===null){foundQ=pNum(txt);}

    // Nothing matched at all â†’ ignore (background noise etc)
    if(foundP<0&&foundT<0&&foundQ===null)return;

    if(foundP>=0){pI=foundP;vGotP=true;upd();}
    if(foundT>=0){tI=foundT;vGotT=true;upd();}
    if(foundQ!==null){qty=String(foundQ);vGotQ=true;upd();}
    if(checkComplete())return;

    // Partial match â†’ ask for missing items
    var ok=[];if(vGotP)ok.push(P[pI].name);if(vGotT)ok.push(T[tI].name);if(vGotQ)ok.push(qty);
    var okMsg=ok.length>0?ok.join('ã€')+'ã€‚':'';
    if(!vGotP){vS=1;document.getElementById('vStep').textContent='åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„';document.getElementById('vText').textContent=okMsg+'å ´æ‰€ãŒä¸æ˜';speakTTS(okMsg+'åé›†å ´æ‰€ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„');}
    else if(!vGotT){vS=2;document.getElementById('vStep').textContent='ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„';document.getElementById('vText').textContent=okMsg+'ç¨®åˆ¥ãŒä¸æ˜';speakTTS(okMsg+'ã”ã¿ç¨®åˆ¥ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„');}
    else{vS=3;document.getElementById('vStep').textContent='æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„';document.getElementById('vText').textContent=okMsg+'æ•°é‡ãŒä¸æ˜';speakTTS(okMsg+'æ•°é‡ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„');}
  }
  else if(vS===1){
    var m=bm(txt,P.map(function(p){return p.name;}));
    if(m>=0){
      pI=m;vGotP=true;upd();document.getElementById('vText').textContent='å ´æ‰€:'+P[m].name+' âœ“';
      if(checkComplete())return;
      if(!vGotT){vS=2;document.getElementById('vStep').textContent='ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS(P[m].name+'ã€‚æ¬¡ã«ã€ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„');}
      else{vS=3;document.getElementById('vStep').textContent='æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS(P[m].name+'ã€‚æ¬¡ã«ã€æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„');}
    }else{document.getElementById('vText').textContent='"'+txt+'" â†’ åé›†å ´æ‰€ãŒä¸€è‡´ã—ã¾ã›ã‚“';speakTTS('åé›†å ´æ‰€ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„');}
  }
  else if(vS===2){
    var m2=bm(txt,T.map(function(t){return t.name;}));
    if(m2>=0){
      tI=m2;vGotT=true;upd();document.getElementById('vText').textContent='ç¨®åˆ¥:'+T[m2].name+' âœ“';
      if(checkComplete())return;
      if(!vGotQ){vS=3;document.getElementById('vStep').textContent='æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS(T[m2].name+'ã€‚æ¬¡ã«ã€æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„');}
      else{vS=1;document.getElementById('vStep').textContent='åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS(T[m2].name+'ã€‚æ¬¡ã«ã€åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„');}
    }else{document.getElementById('vText').textContent='"'+txt+'" â†’ ã”ã¿ç¨®åˆ¥ãŒä¸€è‡´ã—ã¾ã›ã‚“';speakTTS('ã”ã¿ç¨®åˆ¥ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„');}
  }
  else if(vS===3){
    var n=pNum(txt);
    if(n!==null){
      qty=String(n);vGotQ=true;upd();document.getElementById('vText').textContent='æ•°é‡:'+qty+' âœ“';
      if(checkComplete())return;
      if(!vGotP){vS=1;document.getElementById('vStep').textContent='åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS('æ•°é‡'+n+'ã€‚æ¬¡ã«ã€åé›†å ´æ‰€ã‚’è©±ã—ã¦ãã ã•ã„');}
      else{vS=2;document.getElementById('vStep').textContent='ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„';speakTTS('æ•°é‡'+n+'ã€‚æ¬¡ã«ã€ã”ã¿ç¨®åˆ¥ã‚’è©±ã—ã¦ãã ã•ã„');}
    }else{document.getElementById('vText').textContent='"'+txt+'" â†’ æ•°é‡ãŒèãå–ã‚Œã¾ã›ã‚“';speakTTS('æ•°é‡ãŒèãå–ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ã€æ•°é‡ã‚’è©±ã—ã¦ãã ã•ã„');}
  }
}

// === MATCHING & PARSING ===
function bm(inp,list){var s=inp.toLowerCase().replace(/\s/g,'');var i=list.findIndex(function(x){return x.toLowerCase().replace(/\s/g,'')===s;});if(i>=0)return i;i=list.findIndex(function(x){return x.toLowerCase().replace(/\s/g,'').indexOf(s)>=0;});if(i>=0)return i;i=list.findIndex(function(x){return s.indexOf(x.toLowerCase().replace(/\s/g,''))>=0;});return i;}
function pNum(t){var c=t.replace(/[^0-9ï¼-ï¼™.ï¼ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]/g,'');c=c.replace(/[ï¼-ï¼™]/g,function(s){return String.fromCharCode(s.charCodeAt(0)-65248);});c=c.replace(/[ï¼]/g,'.');var km={ä¸€:1,äºŒ:2,ä¸‰:3,å››:4,äº”:5,å…­:6,ä¸ƒ:7,å…«:8,ä¹:9,å:10,ç™¾:100,åƒ:1000,ä¸‡:10000};if(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]/.test(c)){var r=0,cur=0;for(var j=0;j<c.length;j++){var ch=c[j];if(km[ch]!==undefined){var v=km[ch];if(v>=10){cur=(cur||1)*v;if(v>=10000){r+=cur;cur=0;}}else cur+=v;}}r+=cur;if(r>0)return r;}var n=parseFloat(c);if(!isNaN(n))return n;var dm=t.match(/[\dï¼-ï¼™]+[.ï¼]?[\dï¼-ï¼™]*/);if(dm){var x=parseFloat(dm[0].replace(/[ï¼-ï¼™]/g,function(s){return String.fromCharCode(s.charCodeAt(0)-65248);}));if(!isNaN(x))return x;}return null;}

// === DATA ===
function ld(){try{P=JSON.parse(localStorage.getItem('wc_p')||'[]');T=JSON.parse(localStorage.getItem('wc_t')||'[]');R=JSON.parse(localStorage.getItem('wc_r')||'[]');}catch(e){}}
function sP(){localStorage.setItem('wc_p',JSON.stringify(P));}
function sT(){localStorage.setItem('wc_t',JSON.stringify(T));}
function sR(){localStorage.setItem('wc_r',JSON.stringify(R));}
function initGPS(){if(!navigator.geolocation)return;navigator.geolocation.watchPosition(function(p){gLa=p.coords.latitude;gLo=p.coords.longitude;sortP();upd();},function(){},{enableHighAccuracy:true,maximumAge:10000});}
function sortP(){if(gLa===null||!P.length)return;var cn=P[pI]?P[pI].name:'';P.sort(function(a,b){return dst(gLa,gLo,a.lat,a.lng)-dst(gLa,gLo,b.lat,b.lng);});sP();var ni=P.findIndex(function(p){return p.name===cn;});pI=ni>=0?ni:0;}
function dst(a,b,c,d){if(!c||!d)return Infinity;var R2=6371000,dL=(c-a)*Math.PI/180,dG=(d-b)*Math.PI/180;var x=Math.sin(dL/2)*Math.sin(dL/2)+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)*Math.sin(dG/2);return R2*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

// === UI ===
function upd(){
  if(P.length){pI=Math.max(0,Math.min(pI,P.length-1));document.getElementById('pVal').textContent=P[pI].name;var ph=P[pI].photo;document.getElementById('pBox').innerHTML=ph?'<img src="'+ph+'">':'<div class="no-photo"><span>ğŸ“·</span>å†™çœŸãªã—</div>';}
  else{document.getElementById('pVal').textContent='---';document.getElementById('pBox').innerHTML='<div class="no-photo"><span>ğŸ“·</span>å†™çœŸãªã—</div>';}
  if(T.length){tI=Math.max(0,Math.min(tI,T.length-1));document.getElementById('tVal').textContent=T[tI].name;}else document.getElementById('tVal').textContent='---';
  document.getElementById('qVal').textContent=qty;
}
function cyP(d){if(!P.length)return;pI=(pI+d+P.length)%P.length;upd();}
function cyT(d){if(!T.length)return;tI=(tI+d+T.length)%T.length;upd();}
function openNP(){numV=qty==='0'?'':qty;document.getElementById('npD').textContent=numV||'0';document.getElementById('npOvl').classList.add('show');}
function nk(k){if(k==='C')numV='';else if(k==='B')numV=numV.slice(0,-1);else if(k==='E'){qty=numV||'0';document.getElementById('npOvl').classList.remove('show');upd();return;}else{if(k==='.'&&numV.includes('.'))return;if(k==='-'&&numV.length>0)return;numV+=k;}document.getElementById('npD').textContent=numV||'0';}
function saveRec(){
  if(!P.length){toast('åé›†å ´æ‰€ã‚’è¨­å®šã—ã¦ãã ã•ã„');return;}if(!T.length){toast('ã”ã¿ç¨®åˆ¥ã‚’è¨­å®šã—ã¦ãã ã•ã„');return;}
  var now=new Date();R.unshift({time:now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),date:now.toLocaleDateString('ja-JP'),place:P[pI].name,type:T[tI].name,qty:qty,ts:now.getTime()});
  sR();rRec();toast('âœ“ è¨˜éŒ²ã—ã¾ã—ãŸ');qty='0';upd();
}
function rRec(){var c=document.getElementById('recScr');if(!R.length){c.innerHTML='<div class="no-rec">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}c.innerHTML=R.slice(0,100).map(function(r){return '<div class="ri"><div class="rt">'+r.time+'</div><div class="rp">'+r.place+'</div><div class="ry">'+r.type+'</div><div class="rq">'+r.qty+'</div></div>';}).join('');}
function clearRecs(){if(!confirm('å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;R=[];sR();rRec();toast('å…¨å‰Šé™¤ã—ã¾ã—ãŸ');}

// === SETTINGS ===
function openSet(){document.getElementById('setOvl').classList.add('show');rM();}
function closeSet(){document.getElementById('setOvl').classList.remove('show');upd();}
function swT(t){cTab=t;document.getElementById('tabP').classList.toggle('active',t==='place');document.getElementById('tabT').classList.toggle('active',t==='type');rM();}
function rM(){var items=cTab==='place'?P:T,c=document.getElementById('mCtn');if(!items.length){c.innerHTML='<div style="text-align:center;color:#999;padding:16px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';return;}c.innerHTML='<div class="ml">'+items.map(function(it,i){if(cTab==='place'){var ph=it.photo?'<img src="'+it.photo+'">':'ğŸ“·';var d=gLa!==null&&it.lat?Math.round(dst(gLa,gLo,it.lat,it.lng))+'m':'---';return '<div class="mi"><div class="mi-ph">'+ph+'</div><div class="mi-i"><div class="mi-n">'+it.name+'</div><div class="mi-s">ğŸ“'+d+'</div></div><div class="mi-a"><button onclick="edM('+i+')">âœï¸</button><button class="del" onclick="dlM('+i+')">ğŸ—‘</button></div></div>';}return '<div class="mi"><div class="mi-i"><div class="mi-n">'+it.name+'</div></div><div class="mi-a"><button onclick="edM('+i+')">âœï¸</button><button class="del" onclick="dlM('+i+')">ğŸ—‘</button></div></div>';}).join('')+'</div>';}
function dlM(i){if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;if(cTab==='place'){P.splice(i,1);sP();if(pI>=P.length)pI=Math.max(0,P.length-1);}else{T.splice(i,1);sT();if(tI>=T.length)tI=Math.max(0,T.length-1);}rM();}
function addM(){eI=-1;ePh=null;document.getElementById('frmTtl').textContent='æ–°è¦è¿½åŠ ';document.getElementById('fN').value='';document.getElementById('fgPh').style.display=cTab==='place'?'':'none';document.getElementById('fgGps').style.display=cTab==='place'?'':'none';document.getElementById('fLa').value='';document.getElementById('fLo').value='';document.getElementById('pp').innerHTML='<span>ğŸ“·</span>ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠ';document.getElementById('frmOvl').classList.add('show');}
function edM(i){eI=i;var items=cTab==='place'?P:T,it=items[i];document.getElementById('frmTtl').textContent='ç·¨é›†';document.getElementById('fN').value=it.name;document.getElementById('fgPh').style.display=cTab==='place'?'':'none';document.getElementById('fgGps').style.display=cTab==='place'?'':'none';if(cTab==='place'){document.getElementById('fLa').value=it.lat||'';document.getElementById('fLo').value=it.lng||'';ePh=it.photo||null;document.getElementById('pp').innerHTML=it.photo?'<img src="'+it.photo+'">':'<span>ğŸ“·</span>ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠ';}document.getElementById('frmOvl').classList.add('show');}
function closeFrm(){document.getElementById('frmOvl').classList.remove('show');}
function onPh(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');var mx=300;var w=img.width,h=img.height;if(w>h){if(w>mx){h=h*mx/w;w=mx;}}else{if(h>mx){w=w*mx/h;h=mx;}}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);ePh=cv.toDataURL('image/jpeg',0.7);document.getElementById('pp').innerHTML='<img src="'+ePh+'">';};img.src=ev.target.result;};r.readAsDataURL(f);e.target.value='';document.getElementById('phCam').value='';document.getElementById('phLib').value='';}
function getGPS(){if(!navigator.geolocation){toast('GPSéå¯¾å¿œ');return;}toast('GPSå–å¾—ä¸­...');navigator.geolocation.getCurrentPosition(function(p){document.getElementById('fLa').value=p.coords.latitude.toFixed(6);document.getElementById('fLo').value=p.coords.longitude.toFixed(6);toast('GPSå–å¾—å®Œäº†');},function(){toast('GPSå–å¾—å¤±æ•—');},{enableHighAccuracy:true});}
function saveFrm(){var name=document.getElementById('fN').value.trim();if(!name){toast('åå‰ã‚’å…¥åŠ›');return;}if(cTab==='place'){var it={name:name,lat:parseFloat(document.getElementById('fLa').value)||0,lng:parseFloat(document.getElementById('fLo').value)||0,photo:ePh};eI>=0?P[eI]=it:P.push(it);sP();}else{var it2={name:name};eI>=0?T[eI]=it2:T.push(it2);sT();}closeFrm();rM();toast('ä¿å­˜ã—ã¾ã—ãŸ');}
function showExp(){if(!R.length){toast('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');return;}var lines=['æ—¥ä»˜,æ™‚åˆ»,åé›†å ´æ‰€,ã”ã¿ç¨®åˆ¥,åé›†é‡'];R.forEach(function(r){lines.push(r.date+','+r.time+','+r.place+','+r.type+','+r.qty);});document.getElementById('eTxt').value=lines.join('\n');document.getElementById('eOvl').classList.add('show');}
function cpExp(){var t=document.getElementById('eTxt');t.select();try{navigator.clipboard.writeText(t.value);toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');}catch(e){document.execCommand('copy');toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');}}
function toast(m){var e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(function(){e.classList.remove('show');},2000);}
</script>
</body>
</html>
